var LABEL_REGEX=/^\d+-(\w+)/,Gira=function(a,b,c,d){this.username=a,this.repo=b,this.owner=a,this.milestone=d||"",this.last_label="",this.github=c,this.milestones={},this.owners={}};Gira.prototype={renderError:function(a){$(".notification").html(nunjucks.render("src/templates/error.html",{message:a})),window.setTimeout(function(){$(".notification .close.js-flash-close").click()},2e3)},groupIssuesByLabels:function(){var a=this;return Q.all([this.github.getIssues(this.owner,this.repo,this.milestone),this.github.getLabels(this.owner,this.repo)]).then(function(b){var c=b[0],d=_(b[1]).filter(function(a){return LABEL_REGEX.test(a.name)}),e=_(c).groupBy(function(a){var b=_(a.labels).find(function(a){return LABEL_REGEX.test(a.name)});return b?b.name:"0-Backlog"});return _.chain(d.concat({name:"0-Backlog"})).sortBy(function(a){return a.name}).uniq(!0,function(a){return a.name}).tap(function(b){a.last_label=b[b.length-1].name}).map(function(a){return[a.name,e[a.name]]}).value()}).catch(function(b){a.renderError(JSON.parse(b.responseText).message)})},draggablify:function(){var a=this,b=$("#contributions-calendar .contrib-details.grid .col .lbl div[draggable=true]");b.on("dragstart",function(a){a.originalEvent.dataTransfer.effectAllowed="move",a.originalEvent.dataTransfer.setData("text/plain",this.id)}),$(".col").on("dragover",function(a){return a.preventDefault&&a.preventDefault(),$(this).removeClass("over").addClass("over"),a.originalEvent.dataTransfer.dropEffect="move",!1}).on("drop",function(b){b.stopPropagation&&b.stopPropagation();var c=this,d=$("#"+b.originalEvent.dataTransfer.getData("text/plain"));return a.github.deleteLabel(a.owner,a.repo,d.attr("id"),d.data("label")).then(function(b){a.github.addLabel(a.owner,a.repo,d.attr("id"),_(b).pluck("name").concat(c.id))}),$(this).removeClass("over").find("span.lbl").append($(d)),!1})},changeOwner:function(a){this.owner=$(a.target).attr("name"),this.renderRepoSelector()},changeRepo:function(a){this.repo=$(a.target).attr("name"),this.renderKanban()},renderRepoSelector:function(){var a=this;if(this.github.checkLogin())return this.github.getRepos().then(function(b){var c=_(b).groupBy(function(a){return a.owner.login});a.repo=a.repo||c[a.owner][0].name;var d={checked:a.owner,checkedRepo:a.repo,owners:_(c).map(function(a){return a[0].owner}),repos:c[a.owner]},e=nunjucks.render("src/templates/repo-selector.html",d);$(".pagehead.repohead h1").html(e),$(".select-menu.owner-select-menu input[type=radio]").on("change",a.changeOwner.bind(a)),$(".target-repo-menu.select-menu input[type=radio]").on("change",a.changeRepo.bind(a))});var b=nunjucks.render("src/templates/repo-selector.html",{username:a.username,repo:a.repo});return $(".pagehead.repohead h1").html(b),Q()},renderKanban:function(){var a=this;return this.groupIssuesByLabels().then(function(b){var c=mynunjucks.render("src/templates/gira.html",{issuesWithLabel:b,last_label:a.last_label});$("#contributions-calendar").html(c)}).then(a.draggablify.bind(a)).then(function(){$("a[rel=facebox]").click(a.renderFaceBox())}).then(function(){$(".close.close-issue").click(function(){var b=$(this);a.github.getIssues(a.owner,a.repo,a.milestone,b.data("issue")).then(function(c){c.state="close",c.assignee=c.assignee&&c.assignee.login,c.milestone=c.milestone&&c.milestone.number,a.github.newIssue(a.owner,a.repo,c,c.number).then(function(){$("#"+b.data("issue")).remove()})})})})},renderHeader:function(){var a=this;this.github.checkLogin()?this.github.getUser().then(function(b){a.owner=a.owner||b.login,$(".header").html(nunjucks.render("src/templates/header.html",{user:b})),$(".octicon.octicon-log-out").click(a.github.logout)},function(){$(".header").html(nunjucks.render("src/templates/header.html"))}):$(".header").html(nunjucks.render("src/templates/header.html"))},renderMilestone:function(){var a=this;this.github.getMilestones(this.owner,this.repo).then(function(b){$(".pagehead.repohead div.sidebar-milestone-widget").html(mynunjucks.render("src/templates/milestones.html",{selected:a.milestone&&_(b).find(function(b){return b.number===a.milestone}),milestones:b})),$(".sidebar-milestone-widget .select-menu a.select-menu-item").click(function(b){return b.preventDefault(),a.milestone=$(this).data("milestone"),a.render(),!1})})},createLabel:function(){var a=this;return function(){var b=$("form:visible");return a.github.createLabel(a.owner,a.repo,{color:b.find("input[name=color]").val().replace("#",""),name:parseInt(/^(\d+)-\w+/.exec(a.last_label).pop())+1+"-"+b.find("input[name=label]").val()}).then(function(){a.render(),$(".facebox-close").click()}),!1}},createIssue:function(){var a=this;return function(){var b=$("form:visible");return a.github.newIssue(a.owner,a.repo,{title:b.find("input[name='issue[title]']").val(),body:b.find("textarea[name='issue[body]']").val(),assignee:b.find(".assignee input[type=radio]:checked").val(),milestone:b.find(".milestone input[type=radio]:checked").val(),labels:b.find("a.selected input").get().map(function(a){return a.value})},b.data("issue-id")).then(function(){a.render(),$(".facebox-close").click()}),!1}},bindEvent:function(){var a=this;$("#jk-preview").click(function(){var b={text:$("#issue_body").val()};a.github.markdown(b).then(function(a){a&&$(".comment-body.markdown-body.js-comment-body p").html(a)})}),$(".sidebar .color-label").click(function(a){a.preventDefault(),$(this).toggleClass("selected")}),$(".form-actions .primary.button").submit(function(){a.renderKanban()})},renderFaceBox:function(){var a=this;return function(b){if(b.preventDefault(),"new-issue"===this.id){var c=[{},a.github.getAssignees(a.owner,a.repo),a.github.getMilestones(a.owner,a.repo),a.github.getLabels(a.owner,a.repo),{}];a.renderIssueBox(c)}else if("new-label"===this.id)$(".facebox-content:visible").html(nunjucks.render("src/templates/create-label.html"));else if("show-diagram"===this.id)$(".facebox-content:visible").html(nunjucks.render("src/templates/show-diagram.html"));else{var c=[a.github.getIssues(a.owner,a.repo,null,$(this).data("issue-id")),a.github.getAssignees(a.owner,a.repo),a.github.getMilestones(a.owner,a.repo),a.github.getLabels(a.owner,a.repo)];a.renderIssueBox(c)}return!1}},renderIssueBox:function(a){var b=this;Q.all(a).then(function(a){console.log(a);var c=a[0];c.assignees=a[1],c.milestones=a[2],c.all_labels=a[3],c.comments=a[4],$(".facebox-content").html(mynunjucks.render("src/templates/edit-issue.html",c)),"undefined"!=typeof c.labels&&b.updateLabelStatus(c)}).then(b.bindEvent).then(b.bindUploadImageEvent)},updateLabelStatus:function(a){var b=a.labels;$.each(b,function(a,b){$('.sidebar .color-label-list li[data-name="'+b.name+'"] a').addClass("selected")})},bindUploadImageEvent:function(){$("#write_bucket_").bind("drop",function(){function a(a){var b=new FileReader;b.onload=function(){},b.readAsDataURL(a),$.data(a)}function b(a){d.html(a)}var c=$("#write_bucket_"),d=$(".drag-and-drop",c);c.filedrop({paramname:"pic",maxfiles:5,maxfilesize:2,withCredentials:!0,url:"/upload",headers:{"Access-Control-Allow-Origin":"*"},uploadFinished:function(a,b,c){var d=$("#issue_body").val();$("#issue_body").val(d+"\n![Alt text](/images/"+c+")")},allowedfiletypes:["image/jpeg","image/png","image/gif"],allowedfileextensions:[".jpg",".jpeg",".png",".gif"],error:function(a,c){switch(a){case"BrowserNotSupported":b("Your browser does not support HTML5 file uploads!");break;case"TooManyFiles":alert("Too many files! Please select 5 at most!");break;case"FileTooLarge":alert(c.name+" is too large! Please upload files up to 2mb.")}},beforeEach:function(){},uploadStarted:function(b,c){a(c)}})})},closeButton:function(){var a=this;$(".remove-lane").on("click",function(b){b.preventDefault();var c=$(this).attr("data");a.github.deleteLane(a.owner,a.repo,c),a.render()})},render:function(){var a=this;return a.renderHeader(),a.renderRepoSelector().then(a.renderMilestone.bind(a)).then(a.renderKanban.bind(a)).then(a.closeButton.bind(a)).catch(function(a){console.log(a)})}};